name: Deploy to AWS EC2

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 1. Checkout Code
      uses: actions/checkout@v3

    - name: 2. Setup Node.js and Cache
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm' # Use NPM caching for faster installs

    - name: 3. Install Dependencies
      run: npm ci # Use 'npm ci' for clean, faster installation

    - name: 4. Build Project
      run: NODE_OPTIONS="--max-old-space-size=4096" npm run build

    - name: 5. Copy Build Artifacts and Source Code to EC2
      uses: appleboy/scp-action@master
      with:
        host: 51.20.78.210
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "package.json,package-lock.json,next.config.mjs,public,ecosystem.config.js,.next,app,components,lib,contexts,types,middleware.ts,tsconfig.json" # Include source files for API routes
        target: "/home/ubuntu/Business-Orbit"

    - name: 6. Restart PM2 on EC2
      uses: appleboy/ssh-action@master
      with:
        host: 51.20.78.210
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e # Exit immediately if a command exits with a non-zero status.
          
          cd /home/ubuntu/Business-Orbit
          
          echo "ðŸ“¦ Installing production dependencies..."
          npm ci --production # Install only required production dependencies
          
          echo "ðŸ”¨ Rebuilding Next.js application..."
          NODE_OPTIONS="--max-old-space-size=4096" npm run build # Rebuild with increased memory
          
          echo "ðŸ”„ Restarting PM2 applications..."
          pm2 restart all # Restart all named processes
          
          echo "âœ… Deployment complete. Checking status..."
          pm2 list